#!/bin/bash

# requires the following:
# - zip
# - npm

mkdir ./tmp
mkdir ./tmp/wysija-newsletters

# copy assets, languages, sources and the LICENSE

cp ./assets ./tmp/wysija-newsletters -r
cp ./lang ./tmp/wysija-newsletters -r
cp ./lib ./tmp/wysija-newsletters -r
cp ./views ./tmp/wysija-newsletters -r
cp index.php ./tmp/wysija-newsletters
cp mailpoet.php ./tmp/wysija-newsletters
cp LICENSE ./tmp/wysija-newsletters

# copy NPM packages declaration and composer files (including the phar executable)

cp composer.* ./tmp/wysija-newsletters
cp package.json ./tmp/wysija-newsletters

# make sure there are directories for composer's and node's modules

mkdir ./tmp/wysija-newsletters/vendor
mkdir ./tmp/wysija-newsletters/node_modules

# move down to the plugin directory

cd ./tmp/wysija-newsletters

# install nodes and composer dependencies

npm install --production

./composer.phar install --no-dev

# go up to ./tmp and zip the plugin from a whitelist of folders and files and

cd ..
zip -rq ../mailpoet.zip \
	wysija-newsletters/vendor \
	wysija-newsletters/lang \
	wysija-newsletters/assets \
	wysija-newsletters/lib \
	wysija-newsletters/views \
	wysija-newsletters/index.php \
	wysija-newsletters/mailpoet.php \
	wysija-newsletters/LICENCE

# go up the project sources and cleanup ./tmp

cd ..

rm ./tmp -rf